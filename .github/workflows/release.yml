name: Release NIFs

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            builder: action
            use-cross: false
          - runner: ubuntu-22.04
            target: x86_64-unknown-linux-musl
            builder: manual
            use-cross: true
          - runner: ubuntu-22.04
            target: aarch64-unknown-linux-gnu
            builder: manual
            use-cross: true
          - runner: ubuntu-22.04
            target: aarch64-unknown-linux-musl
            builder: manual
            use-cross: true
          - runner: macos-15-intel
            target: x86_64-apple-darwin
            builder: manual
          - runner: macos-14
            target: aarch64-apple-darwin
            builder: manual
          - runner: windows-2022
            target: x86_64-pc-windows-msvc
            builder: manual
    steps:
      - uses: actions/checkout@v4
      - name: Set project version
        shell: bash
        run: |
          version="${GITHUB_REF_NAME#v}"
          echo "PROJECT_VERSION=${version}" >> "$GITHUB_ENV"
      - name: Configure musl flags
        if: contains(matrix.target, 'musl')
        shell: bash
        run: |
          echo "RUSTFLAGS=-C target-feature=-crt-static" >> "$GITHUB_ENV"
      - uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.18.3"
          otp-version: "27.1"
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: philss/rustler-precompiled-action@v1.1.4
        if: matrix.builder == 'action'
        id: build
        with:
          project-name: readability_ex
          project-version: ${{ env.PROJECT_VERSION }}
          target: ${{ matrix.target }}
          nif-version: "2.15"
          use-cross: ${{ matrix.use-cross }}
          project-dir: "native/readability_ex"
      - name: Install cross
        if: matrix.builder == 'manual' && matrix.use-cross
        uses: giantswarm/install-binary-action@v2.0.0
        with:
          binary: "cross"
          version: "v0.2.4"
          download_url: "https://github.com/cross-rs/cross/releases/download/${version}/cross-x86_64-unknown-linux-gnu.tar.gz"
          tarball_binary_path: "${binary}"
          smoke_test: "${binary} --version"
      - name: Build NIF archive (macOS/Linux manual)
        if: matrix.builder == 'manual' && runner.os != 'Windows'
        shell: bash
        working-directory: native/readability_ex
        run: |
          set -euo pipefail
          project_name="readability_ex"
          version="${PROJECT_VERSION}"
          target="${{ matrix.target }}"

          if [ "${{ matrix.use-cross }}" == "true" ]; then
            cross build --release --target="${target}"
          else
            cargo build --release --target="${target}"
          fi

          lib_prefix="lib"
          lib_suffix=".so"
          if [[ "${target}" == *"-apple-darwin" ]]; then
            lib_suffix=".dylib"
          fi

          lib_name="${lib_prefix}${project_name}${lib_suffix}"
          lib_path="target/${target}/release/${lib_name}"

          final_suffix=".so"
          final_name="${lib_prefix}${project_name}-v${version}-nif-2.15-${target}${final_suffix}"

          cp "${lib_path}" "${final_name}"
          tar -czf "${final_name}.tar.gz" "${final_name}"

          echo "ARCHIVE_PATH=$(pwd)/${final_name}.tar.gz" >> "${GITHUB_ENV}"
      - name: Build NIF archive (Windows manual)
        if: matrix.builder == 'manual' && runner.os == 'Windows'
        shell: pwsh
        working-directory: native/readability_ex
        run: |
          $projectName = "readability_ex"
          $version = $env:PROJECT_VERSION
          $target = "${{ matrix.target }}"

          cargo build --release --target $target

          $libName = "$projectName.dll"
          $libPath = "target/$target/release/$libName"
          $finalName = "$projectName-v$version-nif-2.15-$target.dll"

          Copy-Item $libPath $finalName
          tar -czf "$finalName.tar.gz" $finalName

          "ARCHIVE_PATH=$((Resolve-Path $finalName.tar.gz).Path)" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Upload release assets (action)
        if: matrix.builder == 'action'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.build.outputs.file-path }}
      - name: Upload release assets (manual)
        if: matrix.builder == 'manual'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ARCHIVE_PATH }}

  checksum:
    name: Generate checksum
    needs: build
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.18.3"
          otp-version: "27.1"
      - name: Download artifacts
        run: |
          mix deps.get
          mix rustler_precompiled.download Elixir.ReadabilityEx --all --print
      - name: Upload checksum
        uses: actions/upload-artifact@v4
        with:
          name: checksum
          path: checksum-Elixir.ReadabilityEx.exs
