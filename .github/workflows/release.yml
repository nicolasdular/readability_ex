name: Release NIFs

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            use-cross: false
          - runner: ubuntu-22.04
            target: x86_64-unknown-linux-musl
            use-cross: true
          - runner: ubuntu-22.04
            target: aarch64-unknown-linux-gnu
            use-cross: false
          - runner: ubuntu-22.04
            target: aarch64-unknown-linux-musl
            use-cross: true
          - runner: macos-13
            target: x86_64-apple-darwin
            use-cross: false
          - runner: macos-14
            target: aarch64-apple-darwin
            use-cross: false
          - runner: windows-2022
            target: x86_64-pc-windows-msvc
            use-cross: false
    steps:
      - uses: actions/checkout@v4
      - name: Set project version
        shell: bash
        run: |
          version="${GITHUB_REF_NAME#v}"
          echo "PROJECT_VERSION=${version}" >> "$GITHUB_ENV"
      - name: Configure musl flags
        if: contains(matrix.target, 'musl')
        shell: bash
        run: |
          echo "RUSTFLAGS=-C target-feature=-crt-static" >> "$GITHUB_ENV"
      - uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.18.3"
          otp-version: "27.1"
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: philss/rustler-precompiled-action@v1.1.4
        id: build
        with:
          project-name: readability_ex
          project-version: ${{ env.PROJECT_VERSION }}
          target: ${{ matrix.target }}
          nif-version: "2.15"
          use-cross: ${{ matrix.use-cross }}
          project-dir: "native/readability_ex"
      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.build.outputs.file-path }}

  checksum:
    name: Generate checksum
    needs: build
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.18.3"
          otp-version: "27.1"
      - name: Download artifacts
        run: |
          mix deps.get
          mix rustler_precompiled.download Elixir.ReadabilityEx --all --print
      - name: Upload checksum
        uses: actions/upload-artifact@v4
        with:
          name: checksum
          path: checksum-Elixir.ReadabilityEx.exs
